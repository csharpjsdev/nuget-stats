@{
    var packages = PackageRepository.GetPackages(Cache);
    
    // REVIEW: Update this when the format changes
    const string nugetOrgUrlFormat = "http://nuget.org/Packages/Packages/Details/{0}-{1}";
    
    Response.Write(Json.Encode(new {
        TotalCount = String.Format("{0:0,0}", packages.Count),
        UniqueCount = String.Format("{0:0,0}", packages.GroupBy(p => p.Id).Count()),
        TotalDownloads = String.Format("{0:0,0}", packages.GroupBy(p => p.Id).Select(g => g.First().DownloadCount).Sum()),
        LatestPackages = (from p in packages
                          orderby p.LastUpdated descending
                          select new {
                              Id = p.Id,
                              Version = p.Version.ToString(),
                              Url = String.Format(nugetOrgUrlFormat, p.Title, p.Version.ToString().Replace('.', '-'))
                          }).Take(5)
    }));
}
